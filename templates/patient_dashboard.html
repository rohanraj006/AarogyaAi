{% extends "base.html" %}

{% block title %}Patient Dashboard | Aarogya AI{% endblock %}

{% block content %}
<div class="bg-gray-50/50 min-h-screen">
  <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    
    <div class="pb-8 border-b border-gray-200 flex justify-between items-end">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Welcome, {{ user.name.first if user.name else user.email }}</h1>
        <p class="mt-2 text-lg text-gray-600">Manage your health profile and journey.</p>
      </div>
      <button onclick="document.getElementById('editProfileModal').classList.remove('hidden')" 
              class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm">
        Edit Profile
      </button>
    </div>

    <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">

      <div class="lg:col-span-1 space-y-8">
        
        <div class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-indigo-500">
          <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            Personal Details
          </h2>
          <div class="space-y-3 text-gray-700 text-sm">
            <p><span class="font-medium text-gray-900">Full Name:</span> {{ user.name.first }} {{ user.name.last }}</p>
            <p><span class="font-medium text-gray-900">Email:</span> {{ user.email }}</p>
            <p><span class="font-medium text-gray-900">Phone:</span> {{ user.phone_number }}</p>
            <p><span class="font-medium text-gray-900">Aarogya ID:</span> <span class="bg-gray-100 px-2 py-1 rounded text-xs font-mono">{{ user.aarogya_id }}</span></p>
            
            <div class="pt-2 border-t mt-2">
              <p class="font-medium text-gray-900 mb-1">Address:</p>
              <p class="text-gray-500">
                {{ user.address.street }}<br>
                {{ user.address.city }}, {{ user.address.state }} {{ user.address.zip }}<br>
                {{ user.address.country }}
              </p>
            </div>
          </div>
        </div>

       <div class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-green-500">
          <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
            Medical Info
          </h2>
          <div class="space-y-3 text-gray-700 text-sm">
             <div class="grid grid-cols-2 gap-4">
                 <p><span class="font-medium text-gray-900">Age:</span> {{ user.age }} Years</p>
                 <p><span class="font-medium text-gray-900">Gender:</span> {{ user.gender }}</p>
             </div>
             <p><span class="font-medium text-gray-900">Blood Group:</span> 
                <span class="px-2 py-0.5 rounded-full bg-red-100 text-red-800 font-bold">{{ user.blood_group or 'N/A' }}</span>
             </p>
             
             <div class="pt-2 border-t mt-2 space-y-2">
                 <div>
                    <p class="font-medium text-gray-900">Medical Conditions:</p>
                    <p class="text-gray-600 bg-gray-50 p-2 rounded">{{ user.medical_conditions or 'None Listed' }}</p>
                 </div>
                 <div>
                    <p class="font-medium text-gray-900">Allergies:</p>
                    <p class="text-gray-600 bg-gray-50 p-2 rounded">{{ user.allergies or 'None Listed' }}</p>
                 </div>
                 <div>
                    <p class="font-medium text-gray-900">Current Medications:</p>
                    <p class="text-gray-600 bg-gray-50 p-2 rounded">{{ user.current_medications or 'None Listed' }}</p>
                 </div>
             </div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-md border-t-4 border-red-500">
          <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
            Emergency Contact
          </h2>
          <div class="space-y-3 text-gray-700 text-sm">
             {% if user.emergency_contact %}
                 <p><span class="font-medium text-gray-900">Name:</span> {{ user.emergency_contact.name }}</p>
                 <p><span class="font-medium text-gray-900">Relation:</span> {{ user.emergency_contact.relationship }}</p>
                 <p><span class="font-medium text-gray-900">Phone:</span> <a href="tel:{{ user.emergency_contact.phone }}" class="text-indigo-600 hover:underline">{{ user.emergency_contact.phone }}</a></p>
             {% else %}
                 <p class="text-gray-400 italic">No emergency contact set.</p>
             {% endif %}
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-md">
           <h2 class="text-xl font-semibold text-gray-800 border-b pb-3">Quick Actions</h2>
            <div class="mt-4 space-y-4">
            <a href="/appointments" class="block w-full text-center bg-indigo-600 text-white px-5 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition transform hover:scale-105">
                Book an Appointment
            </a>
            <a href="/reports" class="block w-full text-center bg-gray-700 text-white px-5 py-3 rounded-lg font-semibold hover:bg-gray-800 transition transform hover:scale-105">
                Manage My Reports
            </a>
            </div>
        </div>

      </div>

      <div class="lg:col-span-2">
         <div class="bg-white p-6 rounded-2xl shadow-md min-h-full">
          <h2 class="text-xl font-semibold text-gray-800 border-b pb-3">Doctor Connection Requests</h2>
          
          <div id="connection-requests-container" class="mt-6 space-y-4">
            <div id="requests-loader" class="text-center text-gray-500">
              <p>Loading pending requests...</p>
            </div>
            </div>

        </div>
      </div>

    </div>
  </div>
</div>

<div id="editProfileModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-xl bg-white">
        <div class="flex justify-between items-center border-b pb-3">
            <h3 class="text-xl font-bold text-gray-900">Edit Personal Details</h3>
            <button onclick="document.getElementById('editProfileModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form id="editProfileForm" action="/users/update_profile" method="POST" class="mt-4 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">First Name</label>
                    <input name="first_name" value="{{ user.name.first }}" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Last Name</label>
                    <input name="last_name" value="{{ user.name.last }}" required class="w-full border rounded px-3 py-2">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Age</label>
                    <input name="age" type="number" value="{{ user.age }}" required class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Gender</label>
                    <select name="gender" class="w-full border rounded px-3 py-2">
                        <option value="Male" {% if user.gender == 'Male' %}selected{% endif %}>Male</option>
                        <option value="Female" {% if user.gender == 'Female' %}selected{% endif %}>Female</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Phone</label>
                <input name="phone_number" value="{{ user.phone_number }}" required class="w-full border rounded px-3 py-2">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Blood Group</label>
                <select name="blood_group" class="w-full border rounded px-3 py-2">
                   <option value="A+" {% if user.blood_group == 'A+' %}selected{% endif %}>A+</option>
                   <option value="A-" {% if user.blood_group == 'A-' %}selected{% endif %}>A-</option>
                   <option value="B+" {% if user.blood_group == 'B+' %}selected{% endif %}>B+</option>
                   <option value="B-" {% if user.blood_group == 'B-' %}selected{% endif %}>B-</option>
                   <option value="O+" {% if user.blood_group == 'O+' %}selected{% endif %}>O+</option>
                   <option value="O-" {% if user.blood_group == 'O-' %}selected{% endif %}>O-</option>
                   <option value="AB+" {% if user.blood_group == 'AB+' %}selected{% endif %}>AB+</option>
                   <option value="AB-" {% if user.blood_group == 'AB-' %}selected{% endif %}>AB-</option>
                </select>
            </div>

            <div class="border-t pt-3 mt-3">
                <label class="block text-sm font-bold text-gray-700 mb-2">Emergency Contact</label>
                <div class="grid grid-cols-2 gap-2">
                    <input name="emergency_name" value="{{ user.emergency_contact.name if user.emergency_contact else '' }}" class="w-full border rounded px-3 py-2" placeholder="Name">
                    <input name="emergency_relation" value="{{ user.emergency_contact.relationship if user.emergency_contact else '' }}" class="w-full border rounded px-3 py-2" placeholder="Relationship">
                </div>
                <div class="mt-2">
                     <input name="emergency_phone" value="{{ user.emergency_contact.phone if user.emergency_contact else '' }}" class="w-full border rounded px-3 py-2" placeholder="Phone Number">
                </div>
            </div>
            
            <div class="border-t pt-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                <input name="street" value="{{ user.address.street }}" class="w-full border rounded px-3 py-2 mb-2" placeholder="Street">
                <div class="grid grid-cols-2 gap-2">
                    <input name="city" value="{{ user.address.city }}" class="w-full border rounded px-3 py-2" placeholder="City">
                    <input name="state" value="{{ user.address.state }}" class="w-full border rounded px-3 py-2" placeholder="State">
                </div>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <input name="zip_code" value="{{ user.address.zip }}" class="w-full border rounded px-3 py-2" placeholder="Zip">
                    <input name="country" value="{{ user.address.country }}" class="w-full border rounded px-3 py-2" placeholder="Country">
                </div>
            </div>

            <div class="border-t pt-3 mt-3">
                <label class="block text-sm font-bold text-gray-700 mb-2">Medical Details</label>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-500">Medical Conditions</label>
                        <input name="medical_conditions" value="{{ user.medical_conditions or '' }}" class="w-full border rounded px-3 py-2" placeholder="e.g. Asthma">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-500">Allergies</label>
                            <input name="allergies" value="{{ user.allergies or '' }}" class="w-full border rounded px-3 py-2" placeholder="e.g. Pollen">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500">Medications</label>
                            <input name="current_medications" value="{{ user.current_medications or '' }}" class="w-full border rounded px-3 py-2" placeholder="e.g. Aspirin">
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('editProfileModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Attach generic form handler logic from main.js to this new form manually or rely on main.js
    document.addEventListener("DOMContentLoaded", function() {
        const editForm = document.getElementById("editProfileForm");
        if(editForm) {
            editForm.addEventListener("submit", function(e) {
                e.preventDefault();
                const formData = new URLSearchParams(new FormData(editForm));
                fetch(editForm.action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    Swal.fire('Success', data.message, 'success').then(() => location.reload());
                })
                .catch(err => Swal.fire('Error', 'Update failed', 'error'));
            });
        }
    });
</script>
{% endblock %}