{% extends "base.html" %}

{% block title %}Patient Details{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 bg-gradient-to-br from-indigo-100 via-white to-indigo-50 min-h-screen">
    <h1 class="text-4xl md:text-5xl font-extrabold text-indigo-900 mb-10 tracking-tight animate-in fade-in slide-in-from-top duration-700">
        Patient Details
    </h1>

    <div class="mb-8 flex justify-center">
        <div class="inline-flex rounded-lg bg-indigo-50 p-1 border border-indigo-200 shadow-sm">
            <label class="cursor-pointer">
                <input type="radio" name="viewMode" value="both" class="hidden peer" checked onchange="toggleView()">
                <span class="px-4 py-2 rounded-md text-sm font-medium text-indigo-700 peer-checked:bg-indigo-600 peer-checked:text-white transition-colors duration-200">Full View</span>
            </label>
            <label class="cursor-pointer">
                <input type="radio" name="viewMode" value="chatbot" class="hidden peer" onchange="toggleView()">
                <span class="px-4 py-2 rounded-md text-sm font-medium text-indigo-700 peer-checked:bg-indigo-600 peer-checked:text-white transition-colors duration-200">AI Chat</span>
            </label>
            <label class="cursor-pointer">
                <input type="radio" name="viewMode" value="dictation" class="hidden peer" onchange="toggleView()">
                <span class="px-4 py-2 rounded-md text-sm font-medium text-indigo-700 peer-checked:bg-indigo-600 peer-checked:text-white transition-colors duration-200">Dictation & Report</span>
            </label>
        </div>
    </div>

    <div id="basicInfo" class="bg-white p-8 rounded-2xl shadow-xl animate-in fade-in slide-in-from-left duration-700 mb-8 border border-indigo-100">
        <h2 class="text-2xl md:text-3xl font-semibold text-indigo-800 mb-6 flex items-center">
            Basic Information
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="bg-indigo-50 p-4 rounded-lg">
                <p class="font-semibold text-gray-700 text-sm uppercase">Name</p>
                <p class="text-gray-900 mt-1">{{ patient.name.first }} {{ patient.name.last }}</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-lg">
                <p class="font-semibold text-gray-700 text-sm uppercase">Email</p>
                <p class="text-gray-900 mt-1">{{ patient.email }}</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-lg">
                <p class="font-semibold text-gray-700 text-sm uppercase">Phone</p>
                <p class="text-gray-900 mt-1">{{ patient.phone_number }}</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-lg">
                <p class="font-semibold text-gray-700 text-sm uppercase">Age / Gender</p>
                <p class="text-gray-900 mt-1">{{ patient.age }} / {{ patient.gender }}</p>
            </div>
        </div>
    </div>

    {% if medical_record %}
    <div id="medicalInfo" class="bg-white p-8 rounded-2xl shadow-xl animate-in fade-in slide-in-from-right duration-700 mb-8 border border-indigo-100">
        <h2 class="text-2xl md:text-3xl font-semibold text-indigo-800 mb-6">Medical History</h2>
        
        {% if medical_record.allergies %}
        <div class="mb-4">
            <p class="font-semibold text-gray-700">Allergies:</p>
            <ul class="list-disc list-inside pl-4 text-gray-900">
                {% for allergy in medical_record.allergies %}<li>{{ allergy }}</li>{% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if medical_record.current_medications %}
        <div class="mb-4">
            <p class="font-semibold text-gray-700">Current Medications:</p>
            <ul class="list-disc list-inside pl-4 text-gray-900">
                {% for med in medical_record.current_medications %}
                    <li>
                        {% if med is mapping %}
                            {{ med.name }} ({{ med.dosage }})
                        {% else %}
                            {{ med }}
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        {% if medical_record.reports %}
        <div class="mb-4">
            <p class="font-semibold text-gray-700">Recent Reports:</p>
            <ul class="list-disc list-inside pl-4 text-gray-900 text-sm">
                {% for report in medical_record.reports %}
                <li class="mb-2">
                    <strong>{{ report.report_type }}</strong> ({{ report.date.strftime('%Y-%m-%d') if report.date else 'N/A' }})
                    {% if report.description %}
                    <p class="ml-4 text-gray-600 italic">"{{ report.description[:100] }}..."</p>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div id="chatbotSection" class="bg-white p-8 rounded-2xl shadow-xl border border-indigo-100 hidden">
        <h2 class="text-2xl font-semibold text-indigo-800 mb-4">Ask About Patient</h2>
        <div id="chatBox" class="h-80 overflow-y-auto border border-gray-200 rounded-lg p-4 mb-4 bg-gray-50">
            <div class="text-center text-gray-400 italic text-sm">Ask questions like "Does this patient have any allergies?"</div>
        </div>
        <div class="flex gap-2">
            <input type="text" id="chatInput" class="flex-grow p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Type your question...">
            <button id="sendChatBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Send</button>
            <button id="summarizeBtn" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200">Summarize Record</button>
        </div>
    </div>

    <div id="dictationSection" class="bg-white p-8 rounded-2xl shadow-xl border border-indigo-100 hidden">
        <h2 class="text-2xl font-semibold text-indigo-800 mb-4">AI Dictation & Report Generation</h2>
        
        <div class="flex justify-center gap-4 mb-6">
            <button id="startRecordBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                Start Recording
            </button>
            <button id="stopRecordBtn" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden">Stop</button>
        </div>
        <div id="recordingStatus" class="text-center text-sm text-red-500 font-semibold mb-2 hidden">Recording... <span id="timer">0:00</span></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Raw Dictation / Notes</label>
                <textarea id="transcribedText" rows="12" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Speak or type patient notes here..."></textarea>
                <button id="formatReportBtn" class="mt-3 w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>Generate Structured Report</button>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Generated Report Preview</label>
                <div id="reportPreview" class="w-full h-[320px] p-4 border rounded-lg bg-gray-50 overflow-y-auto prose prose-sm">
                    <p class="text-gray-400 italic">Generated report will appear here...</p>
                </div>
                <div class="flex gap-2 mt-3">
                    <button id="generatePdfBtn" class="flex-1 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 disabled:opacity-50" disabled>Download PDF</button>
                    <button id="saveParsedDataBtn" class="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50" disabled>Save to Record</button>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-8 text-center">
        <a href="/doctor/dashboard" class="text-indigo-600 hover:underline">‚Üê Back to Dashboard</a>
    </div>
</div>

<script>
    const patientId = "{{ patient._id }}"; // Patient ID from backend

    // --- VIEW TOGGLE LOGIC ---
    function toggleView() {
        const mode = document.querySelector('input[name="viewMode"]:checked').value;
        const basic = document.getElementById('basicInfo');
        const medical = document.getElementById('medicalInfo');
        const chat = document.getElementById('chatbotSection');
        const dictation = document.getElementById('dictationSection');

        // Hide all first
        [basic, medical, chat, dictation].forEach(el => el && el.classList.add('hidden'));

        if (mode === 'both') {
            basic.classList.remove('hidden');
            if(medical) medical.classList.remove('hidden');
        } else if (mode === 'chatbot') {
            chat.classList.remove('hidden');
        } else if (mode === 'dictation') {
            dictation.classList.remove('hidden');
        }
    }

    // --- CHATBOT LOGIC ---
    const chatInput = document.getElementById('chatInput');
    const chatBox = document.getElementById('chatBox');

    async function sendChat(query, action='ask') {
        if(!query && action === 'ask') return;
        
        // Add User Message
        if(action === 'ask') {
            chatBox.innerHTML += `<div class="text-right mb-2"><span class="bg-indigo-100 text-indigo-800 py-1 px-3 rounded-lg inline-block">${query}</span></div>`;
            chatInput.value = '';
        } else {
            chatBox.innerHTML += `<div class="text-center text-xs text-gray-500 my-2">-- Requesting Summary --</div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            // FIX: Updated URL to match new backend structure
            const res = await fetch(`/doctor/dashboard/patient/${patientId}/chat`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: query, action: action })
            });
            const data = await res.json();
            
            // Add AI Message
            chatBox.innerHTML += `<div class="text-left mb-2"><div class="bg-white border border-gray-200 p-3 rounded-lg inline-block text-sm prose">${data.response.replace(/\n/g, '<br>')}</div></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch(e) {
            chatBox.innerHTML += `<div class="text-center text-red-500 text-xs">Error: ${e.message}</div>`;
        }
    }

    document.getElementById('sendChatBtn').onclick = () => sendChat(chatInput.value, 'ask');
    document.getElementById('summarizeBtn').onclick = () => sendChat('', 'summarize');

    // --- DICTATION LOGIC ---
    let mediaRecorder;
    let audioChunks = [];
    let timerInterval;

    document.getElementById('startRecordBtn').onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = sendAudio;
            
            mediaRecorder.start();
            
            // UI Updates
            document.getElementById('startRecordBtn').classList.add('hidden');
            document.getElementById('stopRecordBtn').classList.remove('hidden');
            document.getElementById('recordingStatus').classList.remove('hidden');
            
            let sec = 0;
            timerInterval = setInterval(() => {
                sec++;
                document.getElementById('timer').innerText = new Date(sec * 1000).toISOString().substr(14, 5);
            }, 1000);

        } catch(e) {
            alert("Microphone access denied or error: " + e.message);
        }
    };

    document.getElementById('stopRecordBtn').onclick = () => {
        if(mediaRecorder) mediaRecorder.stop();
        clearInterval(timerInterval);
        document.getElementById('startRecordBtn').classList.remove('hidden');
        document.getElementById('stopRecordBtn').classList.add('hidden');
        document.getElementById('recordingStatus').classList.add('hidden');
    };

    async function sendAudio() {
        const blob = new Blob(audioChunks, { type: 'audio/wav' });
        const formData = new FormData();
        formData.append('audio_file', blob, 'recording.wav');

        document.getElementById('transcribedText').value = "Transcribing audio...";
        
        try {
            // FIX: Updated URL
            const res = await fetch(`/doctor/dashboard/patient/${patientId}/transcribe`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            document.getElementById('transcribedText').value = data.transcription || "No text detected.";
            document.getElementById('formatReportBtn').disabled = false;
        } catch(e) {
            alert("Transcription failed: " + e.message);
        }
    }

    // --- REPORT GENERATION ---
    document.getElementById('formatReportBtn').onclick = async () => {
        const text = document.getElementById('transcribedText').value;
        if(!text) return;

        document.getElementById('reportPreview').innerHTML = '<div class="animate-pulse">Generating medical report...</div>';
        
        try {
            // FIX: Updated URL
            const res = await fetch(`/doctor/dashboard/patient/${patientId}/generate-report-text`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ transcribed_text: text })
            });
            const data = await res.json();
            
            // Render basic markdown-like formatting
            const formatted = data.report_text.replace(/\n/g, '<br>');
            document.getElementById('reportPreview').innerHTML = formatted;
            
            // Enable next steps
            document.getElementById('generatePdfBtn').disabled = false;
            document.getElementById('saveParsedDataBtn').disabled = false;
        } catch(e) {
            document.getElementById('reportPreview').innerHTML = `<span class="text-red-500">Error: ${e.message}</span>`;
        }
    };

    // --- SAVE PARSED DATA ---
    document.getElementById('saveParsedDataBtn').onclick = async () => {
        const reportContent = document.getElementById('reportPreview').innerText; // Get raw text
        
        Swal.fire({title: 'Saving...', didOpen: () => Swal.showLoading()});

        try {
            // FIX: Updated URL
            const res = await fetch(`/doctor/dashboard/patient/${patientId}/save-parsed-report`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ report_content_text: reportContent })
            });
            const data = await res.json();
            Swal.fire('Success', 'Report saved and medical record updated.', 'success');
        } catch(e) {
            Swal.fire('Error', e.message, 'error');
        }
    };

    // --- PDF DOWNLOAD ---
    document.getElementById('generatePdfBtn').onclick = async () => {
        const reportContent = document.getElementById('reportPreview').innerText;
        
        // Use a fetch to trigger the download or open in new tab
        // FIX: Updated URL
        fetch(`/doctor/dashboard/patient/${patientId}/generate-pdf-report`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ report_content_text: reportContent })
        })
        .then(res => res.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Medical_Report_${patientId}.pdf`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(e => alert("PDF Error: " + e.message));
    };

    // Enable button if text manually edited
    document.getElementById('transcribedText').oninput = (e) => {
        document.getElementById('formatReportBtn').disabled = e.target.value.trim().length === 0;
    };
</script>
{% endblock %}