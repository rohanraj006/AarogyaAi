{% extends "base.html" %}

{% block title %}AI Consultation | Aarogya AI{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-80px)] bg-gray-50 flex flex-col md:flex-row">
    
    <div class="w-full md:w-80 bg-white border-r border-gray-200 p-6 hidden md:flex flex-col">
        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            About Aarogya AI
        </h2>
        
        {% if user.user_type == 'doctor' %}
        <div class="mb-6 p-4 bg-indigo-50 rounded-xl border border-indigo-100 shadow-sm">
            <label for="patientSelect" class="block text-sm font-bold text-indigo-900 mb-2">Select Patient Context</label>
            <p class="text-xs text-indigo-700 mb-3">Choose a patient to ask questions about their specific medical records.</p>
            <div class="relative">
                <select name="patient_id" id="patientSelect" class="block w-full pl-3 pr-10 py-2 text-sm border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">-- General / Myself --</option>
                    {% for patient in patients %}
                        <option value="{{ patient._id }}">{{ patient.name.first }} {{ patient.name.last }} ({{ patient.aarogya_id }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        {% endif %}

        <div class="space-y-6 text-sm text-gray-600">
            <p>
                This is your personal AI medical assistant. It has access to medical history, reports, and profiles.
            </p>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                <h3 class="font-semibold text-gray-800 mb-2">Capabilities</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li>Answer health questions</li>
                    <li>Summarize patient reports</li>
                    <li>Explain medical terms</li>
                    <li>Check symptoms (Triage)</li>
                </ul>
            </div>
            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                <h3 class="font-semibold text-yellow-800 mb-2">Disclaimer</h3>
                <p>AI responses are for informational purposes only. Always consult a doctor for diagnosis.</p>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-[calc(100vh-80px)]">
        
        <div class="md:hidden bg-white border-b border-gray-200 p-4 flex flex-col shadow-sm z-10">
            <div class="flex items-center justify-between">
                <span class="font-bold text-gray-800">Aarogya Assistant</span>
                <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">Beta</span>
            </div>
            {% if user.user_type == 'doctor' %}
            <div class="mt-3">
                <select id="patientSelectMobile" class="block w-full text-sm border-gray-300 rounded-md shadow-sm" onchange="document.getElementById('patientSelect').value = this.value">
                    <option value="">-- Select Patient Context --</option>
                    {% for patient in patients %}
                        <option value="{{ patient._id }}">{{ patient.name.first }} {{ patient.name.last }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>

        <div id="full-chat-messages" 
             class="flex-1 overflow-y-auto p-4 md:p-8 space-y-4 scroll-smooth pb-24"
             hx-get="/ai/chat/history" 
             hx-trigger="load" 
             hx-swap="innerHTML">
             <div class="flex flex-col items-center justify-center h-full space-y-3 opacity-50">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                <p class="text-sm font-medium text-gray-500">Loading conversation history...</p>
             </div>
        </div>

        <div class="bg-white border-t border-gray-200 p-4 md:p-6 shadow-lg z-20">
            <form id="fullChatForm" 
                  hx-post="/ai/chat" 
                  hx-target="#full-chat-messages" 
                  hx-swap="beforeend scroll:bottom"
                  hx-include="#patientSelect" 
                  class="max-w-4xl mx-auto relative flex items-center gap-3">
                
                <div class="relative flex-1">
                    <input type="text" 
                           id="queryInput"
                           name="query" 
                           placeholder="Ask about health, reports, or symptoms..." 
                           required 
                           autocomplete="off"
                           class="w-full pl-5 pr-12 py-4 bg-gray-50 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-gray-800 placeholder-gray-400 shadow-sm transition-all">
                    
                    <button type="submit" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-all shadow-md active:scale-95">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>

                <input type="hidden" name="action" value="ask">
            </form>
            <p class="text-center text-xs text-gray-400 mt-2">Aarogya AI can make mistakes. Consider checking important information.</p>
        </div>
    </div>
</div>

<script>
    const chatForm = document.getElementById('fullChatForm');
    const chatContainer = document.getElementById("full-chat-messages");
    const queryInput = document.getElementById("queryInput");

    // 1. Initial Scroll on Load
    document.body.addEventListener('htmx:afterOnLoad', function(evt) {
        if(evt.detail.elt.id === 'full-chat-messages') {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    });

    // 2. Handle Submit: Add User Message & Thinking Bubble Immediately
    chatForm.addEventListener('htmx:configRequest', function(evt) {
        const text = queryInput.value.trim();
        if(!text) {
            evt.preventDefault();
            return;
        }

        // A. Add User Message
        const userHtml = `
        <div class="flex flex-col space-y-4 mb-6 animate-fade-in">
            <div class="self-end bg-indigo-600 text-white px-5 py-3 rounded-2xl rounded-tr-none max-w-[80%] shadow-md">
                <p class="text-sm">${text}</p>
            </div>
        </div>`;
        chatContainer.insertAdjacentHTML('beforeend', userHtml);

        // B. Add Thinking Bubble (ID used to remove it later)
        const thinkingHtml = `
        <div id="ai-thinking-bubble" class="flex flex-col space-y-4 mb-6 animate-pulse">
            <div class="self-start bg-gray-100 border border-gray-200 text-gray-500 px-5 py-3 rounded-2xl rounded-tl-none max-w-[85%] shadow-sm">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold uppercase tracking-wider">Aarogya AI</span>
                </div>
                <div class="text-sm flex items-center gap-2 mt-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>`;
        chatContainer.insertAdjacentHTML('beforeend', thinkingHtml);
        
        // C. Scroll & Clear Input
        chatContainer.scrollTop = chatContainer.scrollHeight;
        queryInput.value = '';
    });

    // 3. Cleanup After AI Responds
    chatForm.addEventListener('htmx:afterRequest', function(evt) {
        // Remove the thinking bubble
        const thinking = document.getElementById('ai-thinking-bubble');
        if(thinking) thinking.remove();
        
        // Re-focus input so you can type again immediately
        queryInput.focus();
        
        // Scroll to the new message
        chatContainer.scrollTop = chatContainer.scrollHeight;
    });
</script>
{% endblock %}